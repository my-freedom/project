Site.ShoppingCart=function(a){this.moduleId=a;this.module=Fai.top.$("#module"+a);this.shoppingCart=this.module.find(".shoppingCart"+a);this.cartButton=this.module.find(".cartButton");this.cartList=this.module.find(".dropCartList")};(function(f,a,c){var g=a.prototype;g.TITLE="最新加入的商品";g.init=function(){this.initBind();this.refreshData()};g.initBind=function(){var m,l,o=false,p=false;var n=this;var k=this.cartButton,j=this.cartList;if(Fai.top._colId!=13&&Fai.top._colId!=14){k.off("click.sC").on("click.sC",function(){window.open("mcart.jsp","_blank")});k.off("mouseenter.sC").on("mouseenter.sC",function(){if(p){clearTimeout(l);p=false}if(j.is(":hidden")){k.addClass("cartButton_hover");j.css("opacity",0);j.css("height","");j.addClass("dropCartList_hover");var q=j.height();j.css("height",0);j.stop(true,false).animate({height:q,opacity:1},200,function(){j.css("height","");k.addClass("cartButton_hover")});i(n);n.refreshData(n.moduleId)}});k.off("mouseleave.sC").on("mouseleave.sC",function(){o=true;m=setTimeout(function(){k.removeClass("cartButton_hover");j.stop(true,true).animate({height:0,opacity:0},100,function(){j.removeClass("showCartRight dropCartList_hover");k.removeClass("cartButton_hover");j.css("height","")})},50)});j.off("mouseenter.sC").on("mouseenter.sC",function(){if(o){clearTimeout(m);o=false}});j.off("mouseleave.sC").on("mouseleave.sC",function(){p=true;l=setTimeout(function(){k.removeClass("cartButton_hover");j.stop(true,true).animate({height:0,opacity:0},100,function(){j.removeClass("showCartRight dropCartList_hover");k.removeClass("cartButton_hover");j.css("height","")})},50)})}};g.refreshData=function(l){var k=this,j=this.module;f.ajax({type:"post",url:"ajax/order_h.jsp?cmd=getTopBarMallCartList",data:"",success:function(m){var n=f.parseJSON(m);var o=n.topBarProductList;if(n.success&&o.length>0){k.refrestCartList(n.topBarProductList,n.orderId,n.choiceCurrencyVal)}else{j.find(".dropCartList").html(d());j.find(".dropCartList").removeClass("dropCartList_goods");Fai.top.$(".shoppingAmount").css("display","none");Fai.top.$("#mallCart_js").find(".mallCart_proNum").text("(0)")}}})};g.refrestCartList=function(n,l,w){b();var s,v,q,r=n.length,j=this.module,y=Fai.top.$(".shoppingAmount"),k=0,x=0,m=0;var u=[],t=[];u.push("<div class='cartContent'>");u.push("<div class='sCart-title'>");u.push("<h4>"+LS.memberMallCartJoin+"</h4>");u.push("</div>");u.push("<div class='sC-Content'>");u.push("<ul class='sC-sigleList'>");for(v=0;v<r;v++){var o=n[v],p=o.amount;k+=p}for(s=0;s<r;s++){var o=n[s],p=o.amount;if(o.isValid){x+=o.price*p}if(p>1){for(q=0;q<p;q++){if(o.isValid){u.push(h(o,l,w))}else{t.push(h(o,l,w))}m+=1;if(m>=5){break}}if(m>=5){break}}else{if(o.isValid){u.push(h(o,l,w))}else{t.push(h(o,l,w))}m+=1;if(m>=5){break}}}u.push(t.join(""));if(k>0){k=k>99?"99+":k;y.text(k);Fai.top.$("#mallCart_js").find(".mallCart_proNum").text("("+k+")");j.find(".dropCartList").addClass("dropCartList_goods");y.css("display","block")}u.push("</ul>");u.push("</div>");u.push("</div>");u.push("<div class='cartCalculate'>");u.push(Fai.format(LS.shoppingCartCalculatePro,k));u.push("<span class='sC-priceTotal'>"+LS.shoppingCartCountMoney+"<b>"+w.toString()+x+"</b></span>");u.push("</div>");u.push("<div class='cartPayFor'>");u.push("<a href='javascript:;' class='sC-payFor'>"+LS.memberMallCartCheckBtn+"</a>");u.push("</div>");j.find(".shoppingList").html(u.join(""));e(this,l)};g.delShoppingCartItem=function(j,m,l){var k=this;f.ajax({type:"post",url:"ajax/order_h.jsp?cmd=delItem",data:{orderId:j,itemId:m,isTopBarMallCart:true},error:function(n){var o=f.parseJSON(n);if(!o.success){Fai.ing("系统繁忙，请稍后重试。",true)}},success:function(n){var o=f.parseJSON(n);if(o.success){if(k.module.find(".sCart-sigle").length>1){if(k.module.find(".sCart-sigle").length>4){k.module.find(".sC-Content").css("height","295px")}else{k.module.find(".sC-Content").css("height","")}k.module.find(".sCart-sigle").eq(l).stop(true,true).animate({height:"0"},400,function(){k.refreshData()})}else{k.refreshData()}}else{if(o.rt==-2){Fai.ing("参数错误，请稍后重试。",true)}}}})};function e(m,j){var l=m,k=m.module;var n=k.find(".sC-delItem");n.each(function(){var o=f(this);o.off("click.sC").on("click.sC",function(){l.delShoppingCartItem(j,o.attr("tmpproductid"),n.index(o))})});k.find(".cartPayFor a").off("click.sC").on("click.sC",function(){window.open("mcart.jsp","_blank")})}function i(k){var j=k.cartList||k.module.find(".dropCartList");if(j.offset().left<0){j.addClass("showCartRight")}}function h(n,j,m){b();var o=n.isValid;var k=n.inValidType;var l=[];l.push("<li class='sCart-sigle "+(o?"":"invalidItem")+"' itemId='"+n.id+"'>");l.push("<div class='sC-img'>");l.push("<img width='45' height='45' alt="+Fai.encodeHtml(n.name)+" src="+n.picPath+">");l.push("</div>");l.push("<div class='sC-proLeft'>");l.push("<span class='sC-pdName'>"+Fai.encodeHtml(n.name)+"</span>");if(!o){l.push("<span class='sC-invalidTip' title='"+("notAdded"==k?LS.notAdded:LS.inventoryIsZero)+"'>"+LS.invalid+"</span>")}l.push("</div>");l.push("<div class='sC-detail'>");l.push("<span>"+m.toString()+n.price+"</span>");l.push("<br>");l.push("<a class='sC-delItem' hidefocus='true' href='javascript:;' itemId='"+n.id+"'  tmpProductId='"+n.id+"'>"+LS.memberMallCartDel+"</a>");l.push("</div>");l.push("</li>");return l.join("")}function d(){b();var k=g.noGoodsHtmlStr;if(k==c){var j=[];j.push("<div class='cartSpacer'></div>");j.push("<div class='shoppingList'>");j.push("<div class='cartNoGoods'>");j.push("<b></b>");j.push("<div class='noGoodsText'>");j.push("<p>"+LS.memberMallCartNoProduct+"</p>");j.push("</div>");j.push("</div>");j.push("</div>");g.noGoodsHtmlStr=j.join("")}return g.noGoodsHtmlStr}function b(){if(!LS){Fai.ing("多语言文件未引入",false)}}})(jQuery,Site.ShoppingCart);Site.initShoppingCart=function(a){Fai.top.shoppingCart=Fai.top.shoppingCart||{};Fai.top.shoppingCart["cart"+a]=new Site.ShoppingCart(a);Fai.top.shoppingCart["cart"+a].init()};